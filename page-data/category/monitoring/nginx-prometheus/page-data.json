{"componentChunkName":"component---src-templates-post-tsx","path":"/category/monitoring/nginx-prometheus/","result":{"data":{"site":{"siteMetadata":{"title":"Jay 기술 블로그","author":"won0935","siteUrl":"https://won0935.github.io"}},"markdownRemark":{"id":"fb0edc67-5013-518c-b648-9a88d2011a02","excerpt":"⛳ 들어가기 전에.. 🕹 상황 사내 시스템 모니터링 스택 개발 중 ⚙️ 기술 Data Source 현재 실행되고 있는 각 시스템 fluentd(로그수집기), nginx(WS), spring-actuator(상태수집), kafka(MQ) 등 Prometheus…","html":"<h2 id=\"-들어가기-전에\" style=\"position:relative;\"><a href=\"#-%EB%93%A4%EC%96%B4%EA%B0%80%EA%B8%B0-%EC%A0%84%EC%97%90\" aria-label=\" 들어가기 전에 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⛳ 들어가기 전에..</h2>\n<h3 id=\"-상황\" style=\"position:relative;\"><a href=\"#-%EC%83%81%ED%99%A9\" aria-label=\" 상황 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🕹 상황</h3>\n<p>사내 <strong>시스템 모니터링 스택</strong> 개발 중</p>\n<h3 id=\"️-기술\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-%EA%B8%B0%EC%88%A0\" aria-label=\"️ 기술 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⚙️ 기술</h3>\n<h4 id=\"data-source\" style=\"position:relative;\"><a href=\"#data-source\" aria-label=\"data source permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Data Source</h4>\n<ul>\n<li>현재 실행되고 있는 각 시스템</li>\n<li>fluentd(로그수집기), nginx(WS), spring-actuator(상태수집), kafka(MQ) 등</li>\n</ul>\n<h4 id=\"prometheus\" style=\"position:relative;\"><a href=\"#prometheus\" aria-label=\"prometheus permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Prometheus</h4>\n<ul>\n<li>매트릭 수집기 &#x26; 시계열 DB</li>\n<li>각 시스템에서 보내는 정보를 취합하는 역할</li>\n<li><a href=\"https://prometheus.io/docs/introduction/overview/\">Prometheus란?</a></li>\n</ul>\n<h4 id=\"grafana\" style=\"position:relative;\"><a href=\"#grafana\" aria-label=\"grafana permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Grafana</h4>\n<ul>\n<li>매트릭을 시각화 하는 대쉬보드의 역할</li>\n<li><a href=\"https://play.grafana.org/d/000000012/grafana-play-home?orgId=1\">Grafana란?</a></li>\n</ul>\n<h3 id=\"-다이어그램\" style=\"position:relative;\"><a href=\"#-%EB%8B%A4%EC%9D%B4%EC%96%B4%EA%B7%B8%EB%9E%A8\" aria-label=\" 다이어그램 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🎨 다이어그램</h3>\n<p><img src=\"https://user-images.githubusercontent.com/55419159/146768389-a5d3e490-af48-4c14-ad2a-4f3bb0c73d65.png\" alt=\"image\"></p>\n<hr>\n<h2 id=\"-개요\" style=\"position:relative;\"><a href=\"#-%EA%B0%9C%EC%9A%94\" aria-label=\" 개요 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🕹 개요</h2>\n<p>이 문서에서는 <code class=\"language-text\">nginx-prometheus-exporter</code>를 이용해서 <code class=\"language-text\">Nginx</code>의 커넥션 정보에 대한 메트릭을 수집한다.\n그 후 <code class=\"language-text\">Grafana</code>, <code class=\"language-text\">Prometheus</code>를 이용해서 Nginx 웹 서버를 모니터링할 수 있는 대시보드를 구축하는 것에 대하여 다룬다.\n자세한 내용은 다음과 같다.</p>\n<ul>\n<li>Nginx 설치</li>\n<li>nginx-prometheus-exporter 설치</li>\n<li>메트릭 수집을 위한 각 컴포넌트 설정</li>\n<li>Grafana 대시보드 구축</li>\n</ul>\n<p><img src=\"https://user-images.githubusercontent.com/55419159/146769477-69fa4854-444c-4dec-b233-86f64d433815.png\" alt=\"image\"></p>\n<hr>\n<h2 id=\"-nginx-설치\" style=\"position:relative;\"><a href=\"#-nginx-%EC%84%A4%EC%B9%98\" aria-label=\" nginx 설치 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🎁 Nginx 설치</h2>\n<p>Nginx는 대표적인 웹 서버 중 하나로, 가볍고 높은 성능으로 많은 엔지니어들의 사랑(?)을 받고 있다.\n상용 솔루션 뿐 아니라 오픈 소스조차 굉장히 성능이 우수하고, 필요 기능은 공개된 모듈을 통해서 쉽게 커스텀이 가능하기 떄문에 업계 표준으로 자리잡았다.</p>\n<h3 id=\"로컬환경-설치\" style=\"position:relative;\"><a href=\"#%EB%A1%9C%EC%BB%AC%ED%99%98%EA%B2%BD-%EC%84%A4%EC%B9%98\" aria-label=\"로컬환경 설치 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>로컬환경 설치</h3>\n<p>로컬 환경에서는 다음과 같이 Docker로 간단하게 설치 및 구동 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">$ docker run --rm -p <span class=\"token number\">8080</span>:80 nginx</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>다음과 같이 docker-compose로 간단하게 설치 및 구동할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">$ <span class=\"token builtin class-name\">pwd</span>\n/Users/jay/Workspace/jay-prometheus/src/\n\n$ docker compose up -d nginx\n<span class=\"token punctuation\">[</span>+<span class=\"token punctuation\">]</span> Running <span class=\"token number\">2</span>/2\n⠿ Network ch04_default  Created                                                                                                                                                                                                   <span class=\"token number\">0</span>.3s\n⠿ Container nginx       Started</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id=\"서버-설치\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%B2%84-%EC%84%A4%EC%B9%98\" aria-label=\"서버 설치 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>서버 설치</h3>\n<p>서버 환경에서는 다음 명령어로 설치 및 구동이 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token comment\"># 필요 패키지 설치</span>\n$ <span class=\"token function\">sudo</span> yum <span class=\"token function\">install</span> -y yum-utils\n\n<span class=\"token comment\"># nginx 패키지 레포지토리 추가</span>\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/yum.repos.d/nginx.repo <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF\n[nginx-stable]\nname=nginx stable repo\nbaseurl=http://nginx.org/packages/centos/\\<span class=\"token variable\">$releasever</span>/\\<span class=\"token variable\">$basearch</span>/\ngpgcheck=1\nenabled=1\ngpgkey=https://nginx.org/keys/nginx_signing.key\nmodule_hotfixes=true\n\n[nginx-mainline]\nname=nginx mainline repo\nbaseurl=http://nginx.org/packages/mainline/centos/\\<span class=\"token variable\">$releasever</span>/\\<span class=\"token variable\">$basearch</span>/\ngpgcheck=1\nenabled=0\ngpgkey=https://nginx.org/keys/nginx_signing.key\nmodule_hotfixes=true\nEOF</span>\n\n<span class=\"token comment\"># nginx 레포지토리 선택</span>\n$ <span class=\"token function\">sudo</span> yum-config-manager --enable nginx-stable\n\n<span class=\"token comment\"># nginx 설치</span>\n$ <span class=\"token function\">sudo</span> yum <span class=\"token function\">install</span> -y nginx\n\n<span class=\"token comment\"># nginx 구동</span>\n$ <span class=\"token function\">sudo</span> systemctl restart nginx\n\n<span class=\"token comment\"># nginx 구동 상태 확인</span>\n$ <span class=\"token function\">sudo</span> systemctl status nginx\n● nginx.service - nginx - high performance web server\nLoaded: loaded <span class=\"token punctuation\">(</span>/usr/lib/systemd/system/nginx.service<span class=\"token punctuation\">;</span> disabled<span class=\"token punctuation\">;</span> vendor preset: dis<span class=\"token operator\">></span>\nActive: active <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> since Thu <span class=\"token number\">2021</span>-07-22 02:20:48 UTC<span class=\"token punctuation\">;</span> 4s ago\nDocs: http://nginx.org/en/docs/\nProcess: <span class=\"token number\">2037</span> <span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/sbin/nginx -c /etc/nginx/nginx.conf <span class=\"token punctuation\">(</span>code<span class=\"token operator\">=</span>exited, statu<span class=\"token operator\">></span>\n<span class=\"token punctuation\">..</span>.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id=\"설치-결과\" style=\"position:relative;\"><a href=\"#%EC%84%A4%EC%B9%98-%EA%B2%B0%EA%B3%BC\" aria-label=\"설치 결과 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>설치 결과</h3>\n<p>그 후 터미널에 다음을 입력하면 다음 결과를 얻을 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token comment\"># 로컬의 경우</span>\n$ <span class=\"token function\">curl</span> localhost:8080\n\n<span class=\"token comment\"># 서버의 경우</span>\n$ <span class=\"token function\">curl</span> localhost\n\n<span class=\"token comment\"># 결과 출력</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span>Welcome to nginx<span class=\"token operator\">!</span><span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>style<span class=\"token operator\">></span>\n    body <span class=\"token punctuation\">{</span>\n        width: 35em<span class=\"token punctuation\">;</span>\n        margin: <span class=\"token number\">0</span> auto<span class=\"token punctuation\">;</span>\n        font-family: Tahoma, Verdana, Arial, sans-serif<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token operator\">&lt;</span>/style<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>h<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span>Welcome to nginx<span class=\"token operator\">!</span><span class=\"token operator\">&lt;</span>/h<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span>\n<span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span>If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.<span class=\"token operator\">&lt;</span>/p<span class=\"token operator\">></span>\n\n<span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span>For online documentation and support please refer to\n<span class=\"token operator\">&lt;</span>a <span class=\"token assign-left variable\">href</span><span class=\"token operator\">=</span><span class=\"token string\">\"http://nginx.org/\"</span><span class=\"token operator\">></span>nginx.org<span class=\"token operator\">&lt;</span>/a<span class=\"token operator\">></span>.<span class=\"token operator\">&lt;</span>br/<span class=\"token operator\">></span>\nCommercial support is available at\n<span class=\"token operator\">&lt;</span>a <span class=\"token assign-left variable\">href</span><span class=\"token operator\">=</span><span class=\"token string\">\"http://nginx.com/\"</span><span class=\"token operator\">></span>nginx.com<span class=\"token operator\">&lt;</span>/a<span class=\"token operator\">></span>.<span class=\"token operator\">&lt;</span>/p<span class=\"token operator\">></span>\n\n<span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>em<span class=\"token operator\">></span>Thank you <span class=\"token keyword\">for</span> using nginx.<span class=\"token operator\">&lt;</span>/em<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/p<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/html<span class=\"token operator\">></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<hr>\n<h2 id=\"-nginx-prometheus-exporter-설치\" style=\"position:relative;\"><a href=\"#-nginx-prometheus-exporter-%EC%84%A4%EC%B9%98\" aria-label=\" nginx prometheus exporter 설치 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⏰ nginx-prometheus-exporter 설치</h2>\n<p>웹 서버를 모니터링할 때 가장 중요하게 생각되는 지표는 다음과 같다. (물론 더 많을 수 있다.)</p>\n<ul>\n<li>Connection 개수</li>\n<li>Connection 상태</li>\n</ul>\n<p><code class=\"language-text\">Nginx</code>의 <code class=\"language-text\">stub_status</code> 모듈을 활성화시키면 이런 커넥션 정보를 얻을 수 있다.\n오픈 소스에는 볼 수 있는 지표가 적지만, 상용 버전에는 꽤 많은 지표를 확인할 수 있다. </p>\n<p>하지만 모듈을 활성화시켰다고 해서, 커넥션에 대한 메트릭이 자동적으로 수집되는 것은 아니다.\n이를 위해서 <code class=\"language-text\">Nginx</code> 재단은 <code class=\"language-text\">nginx-prometheus-exporter</code>라는 것을 만들고 오픈 소스로 배포해두었다.\n우리는 <code class=\"language-text\">Nginx</code> 웹 서버를 모니터링하기 위해서 이 <code class=\"language-text\">Exporter</code>를 사용할 것이다.</p>\n<p>먼저 로컬에서는 다음과 같이 설치가 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">$ docker pull nginx/nginx-prometheus-exporter:latest</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><code class=\"language-text\">Nginx</code>의 <code class=\"language-text\">stub_status</code> 모듈이 활성화 되어야 실행할 수 있다.</p>\n<h3 id=\"로컬환경-설치-1\" style=\"position:relative;\"><a href=\"#%EB%A1%9C%EC%BB%AC%ED%99%98%EA%B2%BD-%EC%84%A4%EC%B9%98-1\" aria-label=\"로컬환경 설치 1 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>로컬환경 설치</h3>\n<p>역시 이 장의 코드를 다운 받았다면, 다음과 같이 <code class=\"language-text\">docker-compose</code>로 간단하게 설치 및 구동할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">$ <span class=\"token builtin class-name\">pwd</span>\n/Users/gurumee/Workspace/gurumee-book-prometheus/src/part2/ch06\n\n$ docker compose up -d nginx-prometheus-exporter\n<span class=\"token punctuation\">[</span>+<span class=\"token punctuation\">]</span> Running <span class=\"token number\">1</span>/1\n⠿ Container nginx-prometheus-exporter  Started</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id=\"서버-설치-1\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%B2%84-%EC%84%A4%EC%B9%98-1\" aria-label=\"서버 설치 1 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>서버 설치</h3>\n<p>서버 환경에서는 다음 명령어로 설치할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token comment\"># 디렉토리 생성</span>\n$ <span class=\"token function\">mkdir</span> -p ~/apps/nginx-prometheus-exporter\n\n<span class=\"token comment\"># 압축 파일 다운로드</span>\n$ <span class=\"token function\">wget</span> https://github.com/nginxinc/nginx-prometheus-exporter/releases/download/v0.9.0/nginx-prometheus-exporter_0.9.0_linux_amd64.tar.gz\n\n<span class=\"token comment\"># 압축 파일 해제 및 경로 지정</span>\n$ <span class=\"token function\">tar</span> xvf nginx-prometheus-exporter_0.9.0_linux_amd64.tar.gz -C ~/apps/nginx-prometheus-exporter\n\n<span class=\"token comment\"># 압축 파일 삭제</span>\n$ <span class=\"token function\">rm</span> nginx-prometheus-exporter_0.9.0_linux_amd64.tar.gz\n\n<span class=\"token comment\"># 경로 이동</span>\n$ <span class=\"token builtin class-name\">cd</span> ~/apps/nginx-prometheus-exporter\n\n<span class=\"token comment\"># nginx-prometheus-exporter 실행</span>\n$ ./nginx-prometheus-exporter\n<span class=\"token number\">2021</span>/07/22 <span class=\"token number\">10</span>:05:50 Starting NGINX Prometheus Exporter <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token number\">0.9</span>.0 <span class=\"token assign-left variable\">commit</span><span class=\"token operator\">=</span>5f88afbd906baae02edfbab4f5715e06d88538a0 <span class=\"token assign-left variable\">date</span><span class=\"token operator\">=</span><span class=\"token number\">2021</span>-03-22T20:16:09Z\n<span class=\"token number\">2021</span>/07/22 <span class=\"token number\">10</span>:05:50 Could not create Nginx Client: failed to get http://127.0.0.1:8080/stub_status: Get <span class=\"token string\">\"http://127.0.0.1:8080/stub_status\"</span><span class=\"token builtin class-name\">:</span> dial tcp <span class=\"token number\">127.0</span>.0.1:8080: connect:\nconnection refused</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>역시 구동은 되지 않는다. 이제 쉽게 구동하기 위해서 서비스 파일로 등록해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">$ <span class=\"token builtin class-name\">pwd</span>\n/home/sidelineowl/apps/nginx-prometheus-exporter\n\n<span class=\"token comment\"># user 추가</span>\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">useradd</span> -M -r -s /bin/false nginx_prometheus_exporter\n\n<span class=\"token comment\"># 실행 파일 /usr/local/bin/으로 경로 이동</span>\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">cp</span> ./nginx-prometheus-exporter /usr/local/bin\n\n<span class=\"token comment\"># /usr/local/bin/nginx-prometheus-exporter nginx_prometheus_exporter 유저, 그룹 권한 주기</span>\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">chown</span> nginx_prometheus_exporter:nginx_prometheus_exporter /usr/local/bin/nginx-prometheus-exporter\n\n<span class=\"token comment\"># 서비스 파일 등록</span>\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/systemd/system/nginx_prometheus_exporter.service <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF\n[Unit]\nDescription=Nginx Prometheus Exporter\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nUser=nginx_prometheus_exporter\nGroup=nginx_prometheus_exporter\nType=simple\nExecStart=/usr/local/bin/nginx-prometheus-exporter -nginx.scrape-uri http://localhost/metrics\n\n[Install]\nWantedBy=multi-user.target\nEOF</span>\n\n<span class=\"token comment\"># 데몬 리로드</span>\n<span class=\"token comment\"># sudo systemctl daemon-reload</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id=\"실행\" style=\"position:relative;\"><a href=\"#%EC%8B%A4%ED%96%89\" aria-label=\"실행 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>실행</h3>\n<p>이제 서비스 구동을 해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token comment\"># 서비스 구동</span>\n$ <span class=\"token function\">sudo</span> systemctl restart nginx_prometheus_exporter\n\n<span class=\"token comment\"># 서비스 상태 확인</span>\n$ <span class=\"token function\">sudo</span> systemctl status nginx_prometheus_exporter\n● nginx_prometheus_exporter.service - Nginx Prometheus Exporter\nLoaded: loaded <span class=\"token punctuation\">(</span>/etc/systemd/system/nginx_prometheus_exporter.service<span class=\"token punctuation\">;</span> disabled<span class=\"token punctuation\">;</span> vendor preset: disabled<span class=\"token punctuation\">)</span>\nActive: failed <span class=\"token punctuation\">(</span>Result: exit-code<span class=\"token punctuation\">)</span> since Thu <span class=\"token number\">2021</span>-07-22 <span class=\"token number\">10</span>:12:10 UTC<span class=\"token punctuation\">;</span> 21s ago\nProcess: <span class=\"token number\">4110</span> <span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/nginx-prometheus-exporter -nginx.scrape-uri http://localhost/metrics <span class=\"token punctuation\">(</span>code<span class=\"token operator\">=</span>exited, <span class=\"token assign-left variable\">status</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>/FAILURE<span class=\"token punctuation\">)</span>\nMain PID: <span class=\"token number\">4110</span> <span class=\"token punctuation\">(</span>code<span class=\"token operator\">=</span>exited, <span class=\"token assign-left variable\">status</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>/FAILURE<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">..</span>.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">-nginx.scrape-url</code>로 설정한 엔드포인트에 <code class=\"language-text\">stub_status</code> 모듈이 활성화되지 않아서 역시 구동은 안된다.\n여기까지 왔으면 성공이다.</p>\n<hr>\n<h2 id=\"-메트릭-수집을-위한-각-컴포넌트-설정\" style=\"position:relative;\"><a href=\"#-%EB%A9%94%ED%8A%B8%EB%A6%AD-%EC%88%98%EC%A7%91%EC%9D%84-%EC%9C%84%ED%95%9C-%EA%B0%81-%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8-%EC%84%A4%EC%A0%95\" aria-label=\" 메트릭 수집을 위한 각 컴포넌트 설정 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🏮 메트릭 수집을 위한 각 컴포넌트 설정</h2>\n<p>이제 <code class=\"language-text\">Nginx</code>의 <code class=\"language-text\">stub_status</code> 모듈을 활성화시킨다.\n<code class=\"language-text\">/metrics</code> 엔드포인트에 이 모듈이 수집하는 메트릭을 노출시킬 것이다.</p>\n<p><code class=\"language-text\">Nginx</code> 설정 파일을 다음과 같이 수정한다.\n서버 환경에서는 <code class=\"language-text\">/etc/nginx/nginx.conf</code>를 수정하면 된다.\n(로컬 환경에서는 <code class=\"language-text\">docker compose</code>로 모든 컴포넌트를 구동만 하면 된다.)</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">user  nginx<span class=\"token punctuation\">;</span>\nworker_processes  <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\nerror_log  /var/log/nginx/error.log warn<span class=\"token punctuation\">;</span>\npid        /var/run/nginx.pid<span class=\"token punctuation\">;</span>\n\n\nevents <span class=\"token punctuation\">{</span>\nworker_connections  <span class=\"token number\">1024</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nhttp <span class=\"token punctuation\">{</span>\ninclude       /etc/nginx/mime.types<span class=\"token punctuation\">;</span>\ndefault_type  application/octet-stream<span class=\"token punctuation\">;</span>\n\n    log_format  main  <span class=\"token string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span>\n                      <span class=\"token string\">'$status $body_bytes_sent \"$http_referer\" '</span>\n                      <span class=\"token string\">'\"$http_user_agent\" \"$http_x_forwarded_for\"'</span><span class=\"token punctuation\">;</span>\n\n    access_log  /var/log/nginx/access.log  main<span class=\"token punctuation\">;</span>\n    sendfile        on<span class=\"token punctuation\">;</span>\n    keepalive_timeout  <span class=\"token number\">65</span><span class=\"token punctuation\">;</span>\n\n    server <span class=\"token punctuation\">{</span>\n        listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n        proxy_set_header     X-Scope-OrgID docker-ha<span class=\"token punctuation\">;</span>\n\n         location / <span class=\"token punctuation\">{</span>\n            root   /usr/share/nginx/html<span class=\"token punctuation\">;</span>\n            index  index.html index.htm<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\"># stub_status 모듈 활성</span>\n        location /metrics <span class=\"token punctuation\">{</span>\n            stub_status on<span class=\"token punctuation\">;</span>\n            access_log off<span class=\"token punctuation\">;</span>\n            allow all<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>그리고 <code class=\"language-text\">Nginx</code>를 재가동한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">$ <span class=\"token function\">sudo</span> systemctl restart nginx</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>이제 <code class=\"language-text\">curl</code>로 한 번 확인을 해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">$ <span class=\"token function\">curl</span> localhost/metrics\nActive connections: <span class=\"token number\">1</span>\nserver accepts handled requests\n<span class=\"token number\">1</span> <span class=\"token number\">1</span> <span class=\"token number\">1</span>\nReading: <span class=\"token number\">0</span> Writing: <span class=\"token number\">1</span> Waiting: <span class=\"token number\">0</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>이렇게 나오면 성공이다. <code class=\"language-text\">nginx-prometheus-exporter</code> 서비스를 재구동한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">$ <span class=\"token function\">sudo</span> systemctl restart nginx_prometheus_exporter</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>그 후 <code class=\"language-text\">curl</code>로 메트릭이 수집되는지 확인해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">$ <span class=\"token function\">curl</span> localhost:9113/metrics\n<span class=\"token comment\"># HELP nginx_connections_accepted Accepted client connections</span>\n<span class=\"token comment\"># TYPE nginx_connections_accepted counter</span>\nnginx_connections_accepted <span class=\"token number\">2</span>\n<span class=\"token comment\"># HELP nginx_connections_active Active client connections</span>\n<span class=\"token comment\"># TYPE nginx_connections_active gauge</span>\nnginx_connections_active <span class=\"token number\">1</span>\n<span class=\"token comment\"># HELP nginx_connections_handled Handled client connections</span>\n<span class=\"token comment\"># TYPE nginx_connections_handled counter</span>\nnginx_connections_handled <span class=\"token number\">2</span>\n<span class=\"token comment\"># HELP nginx_connections_reading Connections where NGINX is reading the request header</span>\n<span class=\"token comment\"># TYPE nginx_connections_reading gauge</span>\nnginx_connections_reading <span class=\"token number\">0</span>\n<span class=\"token comment\"># HELP nginx_connections_waiting Idle client connections</span>\n<span class=\"token comment\"># TYPE nginx_connections_waiting gauge</span>\nnginx_connections_waiting <span class=\"token number\">0</span>\n<span class=\"token punctuation\">..</span>.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>이제 <code class=\"language-text\">Prometheus</code> 설정 파일을 다음과 같이 수정한다.\n서버에서라면 <code class=\"language-text\">/etc/prometheus/prometheus.yml</code>에 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token comment\"># my global config</span>\nglobal:\nscrape_interval:     15s <span class=\"token comment\"># By default, scrape targets every 15 seconds.</span>\nevaluation_interval: 15s <span class=\"token comment\"># By default, scrape targets every 15 seconds.</span>\n\nexternal_labels:\nmonitor: <span class=\"token string\">'my-project'</span>\n\nrule_files:\n\nscrape_configs:\n<span class=\"token comment\"># ...</span>\n\n- job_name: <span class=\"token string\">'nginx-prometheus-exporter'</span>\n  scrape_interval: 5s\n\n  static_configs:\n  <span class=\"token comment\"># nginx와 nginx-prometheus-exporter가 설치된 IP:9113</span>\n    - targets: <span class=\"token punctuation\">[</span><span class=\"token string\">'nginx-prometheus-exporter:9113'</span><span class=\"token punctuation\">]</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>그리고 <code class=\"language-text\">Prometheus</code>를 재구동한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">$ <span class=\"token function\">sudo</span> systemctl restart prometheus</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>그 후 <code class=\"language-text\">Prometheus UI</code>에서 다음을 쿼리해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\">nginx_up</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>다음과 같이 나오면 성공이다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/55419159/146771916-cd54be72-5e84-4f35-b5ec-233c47e827c2.png\" alt=\"image\"></p>\n<hr>\n<h2 id=\"-grafana-대시보드-구축\" style=\"position:relative;\"><a href=\"#-grafana-%EB%8C%80%EC%8B%9C%EB%B3%B4%EB%93%9C-%EA%B5%AC%EC%B6%95\" aria-label=\" grafana 대시보드 구축 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>📯 Grafana 대시보드 구축</h2>\n<p>이제 대시보드를 구축한다. 다음 JSON 파일을 복사해서 대시보드를 임포트한다. (로컬 환경에는 이미 대시보드가 로드되어 있다.)\n<a href=\"https://grafana.com/grafana/dashboards/9614\">다음 링크</a>로 가서 JSON 파일을 복사한다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/55419159/146773163-8fd10949-e114-4128-8cb4-79d4eb8689df.png\" alt=\"image\"></p>\n<p>다음과 같은 지표를 확인할 수 있다.</p>\n<ul>\n<li><code class=\"language-text\">Nginx</code> 구동 상태</li>\n<li><code class=\"language-text\">Nginx Connection</code> 상태</li>\n<li><code class=\"language-text\">Nginx Connection</code> 개수</li>\n<li><code class=\"language-text\">Nginx</code> 초당 요청 개수</li>\n</ul>","tableOfContents":"<ul>\n<li>\n<p><a href=\"/category/monitoring/nginx-prometheus/#-%EB%93%A4%EC%96%B4%EA%B0%80%EA%B8%B0-%EC%A0%84%EC%97%90\">⛳ 들어가기 전에..</a></p>\n<ul>\n<li><a href=\"/category/monitoring/nginx-prometheus/#-%EC%83%81%ED%99%A9\">🕹 상황</a></li>\n<li>\n<p><a href=\"/category/monitoring/nginx-prometheus/#%EF%B8%8F-%EA%B8%B0%EC%88%A0\">⚙️ 기술</a></p>\n<ul>\n<li><a href=\"/category/monitoring/nginx-prometheus/#data-source\">Data Source</a></li>\n<li><a href=\"/category/monitoring/nginx-prometheus/#prometheus\">Prometheus</a></li>\n<li><a href=\"/category/monitoring/nginx-prometheus/#grafana\">Grafana</a></li>\n</ul>\n</li>\n<li><a href=\"/category/monitoring/nginx-prometheus/#-%EB%8B%A4%EC%9D%B4%EC%96%B4%EA%B7%B8%EB%9E%A8\">🎨 다이어그램</a></li>\n</ul>\n</li>\n<li><a href=\"/category/monitoring/nginx-prometheus/#-%EA%B0%9C%EC%9A%94\">🕹 개요</a></li>\n<li>\n<p><a href=\"/category/monitoring/nginx-prometheus/#-nginx-%EC%84%A4%EC%B9%98\">🎁 Nginx 설치</a></p>\n<ul>\n<li><a href=\"/category/monitoring/nginx-prometheus/#%EB%A1%9C%EC%BB%AC%ED%99%98%EA%B2%BD-%EC%84%A4%EC%B9%98\">로컬환경 설치</a></li>\n<li><a href=\"/category/monitoring/nginx-prometheus/#%EC%84%9C%EB%B2%84-%EC%84%A4%EC%B9%98\">서버 설치</a></li>\n<li><a href=\"/category/monitoring/nginx-prometheus/#%EC%84%A4%EC%B9%98-%EA%B2%B0%EA%B3%BC\">설치 결과</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/category/monitoring/nginx-prometheus/#-nginx-prometheus-exporter-%EC%84%A4%EC%B9%98\">⏰ nginx-prometheus-exporter 설치</a></p>\n<ul>\n<li><a href=\"/category/monitoring/nginx-prometheus/#%EB%A1%9C%EC%BB%AC%ED%99%98%EA%B2%BD-%EC%84%A4%EC%B9%98-1\">로컬환경 설치</a></li>\n<li><a href=\"/category/monitoring/nginx-prometheus/#%EC%84%9C%EB%B2%84-%EC%84%A4%EC%B9%98-1\">서버 설치</a></li>\n<li><a href=\"/category/monitoring/nginx-prometheus/#%EC%8B%A4%ED%96%89\">실행</a></li>\n</ul>\n</li>\n<li><a href=\"/category/monitoring/nginx-prometheus/#-%EB%A9%94%ED%8A%B8%EB%A6%AD-%EC%88%98%EC%A7%91%EC%9D%84-%EC%9C%84%ED%95%9C-%EA%B0%81-%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8-%EC%84%A4%EC%A0%95\">🏮 메트릭 수집을 위한 각 컴포넌트 설정</a></li>\n<li><a href=\"/category/monitoring/nginx-prometheus/#-grafana-%EB%8C%80%EC%8B%9C%EB%B3%B4%EB%93%9C-%EA%B5%AC%EC%B6%95\">📯 Grafana 대시보드 구축</a></li>\n</ul>","frontmatter":{"title":"[모니터링] Nginx 를 Prometheus 로 모니터링 하기","description":"","date":"2021.12.20","emoji":"🚂","category":"monitoring"}}},"pageContext":{"slug":"/category/monitoring/nginx-prometheus/","relatedPosts":[{"node":{"fields":{"slug":"/category/monitoring/oauth2-openid/"},"frontmatter":{"title":"[모니터링] Oauth 2.0과 OpenID Connect 프로토콜 정리","date":"2022.01.29","emoji":"🔒","category":"monitoring"}}},{"node":{"fields":{"slug":"/category/monitoring/jenkins-plugins/"},"frontmatter":{"title":"[모니터링] 폐쇠망에서 Jenkins 업그레이드 & 플러그인 설치하기","date":"2022.01.25","emoji":"🕴","category":"monitoring"}}},{"node":{"fields":{"slug":"/category/monitoring/fluentd-prometheus/"},"frontmatter":{"title":"[모니터링] Fluentd 를 Prometheus 로 모니터링 하기","date":"2021.12.17","emoji":"🔡","category":"monitoring"}}},{"node":{"fields":{"slug":"/category/monitoring/about-kafka/"},"frontmatter":{"title":"[모니터링] Kafka 란","date":"2021.11.28","emoji":"📨","category":"monitoring"}}}]}},"staticQueryHashes":["196006245","1984257895","2528810007"]}