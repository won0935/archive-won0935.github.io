<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta name="google-site-verification" content="kxUeC0-raKMnb_9t28-yR-nUhS3TQp-xOzqvP8qPgZE" />
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Song Jae-won, Jay">



    <meta name="description" content="기억보단 기록으로">



<title>Nginx 를 Prometheus 로 모니터링 하기 | Jay&#39;s Note</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Jay's Note" type="application/atom+xml">
</head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">기억보단 기록으로</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" target="_blank" rel="noopener" href="https://dev-song.notion.site/Clean-Neat-Code-955801f71953414097b2992b1ed9f3b2">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">기억보단 기록으로</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" target="_blank" rel="noopener" href="https://dev-song.notion.site/Clean-Neat-Code-955801f71953414097b2992b1ed9f3b2">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Nginx 를 Prometheus 로 모니터링 하기</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Song Jae-won, Jay</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">December 17, 2021&nbsp;&nbsp;15:47:21</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/Nginx/">Nginx</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="⛳-들어가기-전에"><a href="#⛳-들어가기-전에" class="headerlink" title="⛳ 들어가기 전에.."></a>⛳ 들어가기 전에..</h2><h3 id="🕹-상황"><a href="#🕹-상황" class="headerlink" title="🕹 상황"></a>🕹 상황</h3><p>사내 <strong>시스템 모니터링 스택</strong> 개발 중</p>
<h3 id="⚙️-기술"><a href="#⚙️-기술" class="headerlink" title="⚙️ 기술"></a>⚙️ 기술</h3><h4 id="Data-Source"><a href="#Data-Source" class="headerlink" title="Data Source"></a>Data Source</h4><ul>
<li>현재 실행되고 있는 각 시스템</li>
<li>fluentd(로그수집기), nginx(WS), spring-actuator(상태수집), kafka(MQ) 등</li>
</ul>
<h4 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h4><ul>
<li>매트릭 수집기 &amp; 시계열 DB</li>
<li>각 시스템에서 보내는 정보를 취합하는 역할</li>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/introduction/overview/">Prometheus란?</a></li>
</ul>
<h4 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h4><ul>
<li>매트릭을 시각화 하는 대쉬보드의 역할</li>
<li><a target="_blank" rel="noopener" href="https://play.grafana.org/d/000000012/grafana-play-home?orgId=1">Grafana란?</a></li>
</ul>
<h3 id="🎨-다이어그램"><a href="#🎨-다이어그램" class="headerlink" title="🎨 다이어그램"></a>🎨 다이어그램</h3><p><img src="https://user-images.githubusercontent.com/55419159/146768389-a5d3e490-af48-4c14-ad2a-4f3bb0c73d65.png" alt="image"></p>
<hr>
<h2 id="🕹-개요"><a href="#🕹-개요" class="headerlink" title="🕹 개요"></a>🕹 개요</h2><p>이 문서에서는 <code>nginx-prometheus-exporter</code>를 이용해서 <code>Nginx</code>의 커넥션 정보에 대한 메트릭을 수집한다.<br>그 후 <code>Grafana</code>, <code>Prometheus</code>를 이용해서 Nginx 웹 서버를 모니터링할 수 있는 대시보드를 구축하는 것에 대하여 다룬다.<br>자세한 내용은 다음과 같다.</p>
<ul>
<li>Nginx 설치</li>
<li>nginx-prometheus-exporter 설치</li>
<li>메트릭 수집을 위한 각 컴포넌트 설정</li>
<li>Grafana 대시보드 구축</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/55419159/146769477-69fa4854-444c-4dec-b233-86f64d433815.png" alt="image"></p>
<hr>
<h2 id="🎁-Nginx-설치"><a href="#🎁-Nginx-설치" class="headerlink" title="🎁 Nginx 설치"></a>🎁 Nginx 설치</h2><p>Nginx는 대표적인 웹 서버 중 하나로, 가볍고 높은 성능으로 많은 엔지니어들의 사랑(?)을 받고 있다.<br>상용 솔루션 뿐 아니라 오픈 소스조차 굉장히 성능이 우수하고, 필요 기능은 공개된 모듈을 통해서 쉽게 커스텀이 가능하기 떄문에 업계 표준으로 자리잡았다.</p>
<h3 id="로컬환경-설치"><a href="#로컬환경-설치" class="headerlink" title="로컬환경 설치"></a>로컬환경 설치</h3><p>로컬 환경에서는 다음과 같이 Docker로 간단하게 설치 및 구동 가능하다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run --rm -p 8080:80 nginx</span></span><br></pre></td></tr></table></figure>

<p>다음과 같이 docker-compose로 간단하게 설치 및 구동할 수 있다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">pwd</span></span></span><br><span class="line">/Users/jay/Workspace/jay-prometheus/src/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker compose up -d nginx</span></span><br><span class="line">[+] Running 2/2</span><br><span class="line">⠿ Network ch04_default  Created                                                                                                                                                                                                   0.3s</span><br><span class="line">⠿ Container nginx       Started</span><br></pre></td></tr></table></figure>

<h3 id="서버-설치"><a href="#서버-설치" class="headerlink" title="서버 설치"></a>서버 설치</h3><p>서버 환경에서는 다음 명령어로 설치 및 구동이 가능하다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 필요 패키지 설치</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install -y yum-utils</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> nginx 패키지 레포지토리 추가</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tee /etc/yum.repos.d/nginx.repo &lt;&lt; <span class="string">EOF</span></span></span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/\$releasever/\$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line"></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/\$releasever/\$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line">EOF</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> nginx 레포지토리 선택</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"><span class="string"> sudo yum-config-manager --enable nginx-stable</span></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> nginx 설치</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"><span class="string"> sudo yum install -y nginx</span></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> nginx 구동</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"><span class="string"> sudo systemctl restart nginx</span></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> nginx 구동 상태 확인</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"><span class="string"> sudo systemctl status nginx</span></span></span><br><span class="line">● nginx.service - nginx - high performance web server</span><br><span class="line">Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; vendor preset: dis&gt;</span><br><span class="line">Active: active (running) since Thu 2021-07-22 02:20:48 UTC; 4s ago</span><br><span class="line">Docs: http://nginx.org/en/docs/</span><br><span class="line">Process: 2037 ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf (code=exited, statu&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="설치-결과"><a href="#설치-결과" class="headerlink" title="설치 결과"></a>설치 결과</h3><p>그 후 터미널에 다음을 입력하면 다음 결과를 얻을 수 있다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 로컬의 경우</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl localhost:8080</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 서버의 경우</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl localhost</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 결과 출력</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="⏰-nginx-prometheus-exporter-설치"><a href="#⏰-nginx-prometheus-exporter-설치" class="headerlink" title="⏰ nginx-prometheus-exporter 설치"></a>⏰ nginx-prometheus-exporter 설치</h2><p>웹 서버를 모니터링할 때 가장 중요하게 생각되는 지표는 다음과 같다. (물론 더 많을 수 있다.)</p>
<ul>
<li>Connection 개수</li>
<li>Connection 상태</li>
</ul>
<p><code>Nginx</code>의 <code>stub_status</code> 모듈을 활성화시키면 이런 커넥션 정보를 얻을 수 있다.<br>오픈 소스에는 볼 수 있는 지표가 적지만, 상용 버전에는 꽤 많은 지표를 확인할 수 있다. </p>
<p>하지만 모듈을 활성화시켰다고 해서, 커넥션에 대한 메트릭이 자동적으로 수집되는 것은 아니다.<br>이를 위해서 <code>Nginx</code> 재단은 <code>nginx-prometheus-exporter</code>라는 것을 만들고 오픈 소스로 배포해두었다.<br>우리는 <code>Nginx</code> 웹 서버를 모니터링하기 위해서 이 <code>Exporter</code>를 사용할 것이다.</p>
<p>먼저 로컬에서는 다음과 같이 설치가 가능하다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker pull nginx/nginx-prometheus-exporter:latest</span></span><br></pre></td></tr></table></figure>


<p><code>Nginx</code>의 <code>stub_status</code> 모듈이 활성화 되어야 실행할 수 있다.</p>
<h3 id="로컬환경-설치-1"><a href="#로컬환경-설치-1" class="headerlink" title="로컬환경 설치"></a>로컬환경 설치</h3><p>역시 이 장의 코드를 다운 받았다면, 다음과 같이 <code>docker-compose</code>로 간단하게 설치 및 구동할 수 있다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">pwd</span></span></span><br><span class="line">/Users/gurumee/Workspace/gurumee-book-prometheus/src/part2/ch06</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker compose up -d nginx-prometheus-exporter</span></span><br><span class="line">[+] Running 1/1</span><br><span class="line">⠿ Container nginx-prometheus-exporter  Started</span><br></pre></td></tr></table></figure>

<h3 id="서버-설치-1"><a href="#서버-설치-1" class="headerlink" title="서버 설치"></a>서버 설치</h3><p>서버 환경에서는 다음 명령어로 설치할 수 있다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 디렉토리 생성</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p ~/apps/nginx-prometheus-exporter</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 압축 파일 다운로드</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://github.com/nginxinc/nginx-prometheus-exporter/releases/download/v0.9.0/nginx-prometheus-exporter_0.9.0_linux_amd64.tar.gz</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 압축 파일 해제 및 경로 지정</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar xvf nginx-prometheus-exporter_0.9.0_linux_amd64.tar.gz -C ~/apps/nginx-prometheus-exporter</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 압축 파일 삭제</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rm nginx-prometheus-exporter_0.9.0_linux_amd64.tar.gz</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 경로 이동</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ~/apps/nginx-prometheus-exporter</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> nginx-prometheus-exporter 실행</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./nginx-prometheus-exporter</span></span><br><span class="line">2021/07/22 10:05:50 Starting NGINX Prometheus Exporter version=0.9.0 commit=5f88afbd906baae02edfbab4f5715e06d88538a0 date=2021-03-22T20:16:09Z</span><br><span class="line">2021/07/22 10:05:50 Could not create Nginx Client: failed to get http://127.0.0.1:8080/stub_status: Get &quot;http://127.0.0.1:8080/stub_status&quot;: dial tcp 127.0.0.1:8080: connect:</span><br><span class="line">connection refused</span><br></pre></td></tr></table></figure>


<p>역시 구동은 되지 않는다. 이제 쉽게 구동하기 위해서 서비스 파일로 등록해보자.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">pwd</span></span></span><br><span class="line">/home/sidelineowl/apps/nginx-prometheus-exporter</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> user 추가</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo useradd -M -r -s /bin/<span class="literal">false</span> nginx_prometheus_exporter</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 실행 파일 /usr/<span class="built_in">local</span>/bin/으로 경로 이동</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo cp ./nginx-prometheus-exporter /usr/<span class="built_in">local</span>/bin</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/bin/nginx-prometheus-exporter nginx_prometheus_exporter 유저, 그룹 권한 주기</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo chown nginx_prometheus_exporter:nginx_prometheus_exporter /usr/<span class="built_in">local</span>/bin/nginx-prometheus-exporter</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 서비스 파일 등록</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tee /etc/systemd/system/nginx_prometheus_exporter.service &lt;&lt; <span class="string">EOF</span></span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Nginx Prometheus Exporter</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=nginx_prometheus_exporter</span><br><span class="line">Group=nginx_prometheus_exporter</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/usr/local/bin/nginx-prometheus-exporter -nginx.scrape-uri http://localhost/metrics</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> 데몬 리로드</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> sudo systemctl daemon-reload</span></span></span><br></pre></td></tr></table></figure>

<h3 id="실행"><a href="#실행" class="headerlink" title="실행"></a>실행</h3><p>이제 서비스 구동을 해보자.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 서비스 구동</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl restart nginx_prometheus_exporter</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 서비스 상태 확인</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl status nginx_prometheus_exporter</span></span><br><span class="line">● nginx_prometheus_exporter.service - Nginx Prometheus Exporter</span><br><span class="line">Loaded: loaded (/etc/systemd/system/nginx_prometheus_exporter.service; disabled; vendor preset: disabled)</span><br><span class="line">Active: failed (Result: exit-code) since Thu 2021-07-22 10:12:10 UTC; 21s ago</span><br><span class="line">Process: 4110 ExecStart=/usr/local/bin/nginx-prometheus-exporter -nginx.scrape-uri http://localhost/metrics (code=exited, status=1/FAILURE)</span><br><span class="line">Main PID: 4110 (code=exited, status=1/FAILURE)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>


<p><code>-nginx.scrape-url</code>로 설정한 엔드포인트에 <code>stub_status</code> 모듈이 활성화되지 않아서 역시 구동은 안된다.<br>여기까지 왔으면 성공이다.</p>
<hr>
<h2 id="🏮-메트릭-수집을-위한-각-컴포넌트-설정"><a href="#🏮-메트릭-수집을-위한-각-컴포넌트-설정" class="headerlink" title="🏮 메트릭 수집을 위한 각 컴포넌트 설정"></a>🏮 메트릭 수집을 위한 각 컴포넌트 설정</h2><p>이제 <code>Nginx</code>의 <code>stub_status</code> 모듈을 활성화시킨다.<br><code>/metrics</code> 엔드포인트에 이 모듈이 수집하는 메트릭을 노출시킬 것이다.</p>
<p><code>Nginx</code> 설정 파일을 다음과 같이 수정한다.<br>서버 환경에서는 <code>/etc/nginx/nginx.conf</code>를 수정하면 된다.<br>(로컬 환경에서는 <code>docker compose</code>로 모든 컴포넌트를 구동만 하면 된다.)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">include       /etc/nginx/mime.types;</span><br><span class="line">default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        proxy_set_header     X-Scope-OrgID docker-ha;</span><br><span class="line"></span><br><span class="line">         location / &#123;</span><br><span class="line">            root   /usr/share/nginx/html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # stub_status 모듈 활성</span><br><span class="line">        location /metrics &#123;</span><br><span class="line">            stub_status on;</span><br><span class="line">            access_log off;</span><br><span class="line">            allow all;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>그리고 <code>Nginx</code>를 재가동한다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl restart nginx</span></span><br></pre></td></tr></table></figure>

<p>이제 <code>curl</code>로 한 번 확인을 해보자.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl localhost/metrics</span></span><br><span class="line">Active connections: 1</span><br><span class="line">server accepts handled requests</span><br><span class="line">1 1 1</span><br><span class="line">Reading: 0 Writing: 1 Waiting: 0</span><br></pre></td></tr></table></figure>


<p>이렇게 나오면 성공이다. <code>nginx-prometheus-exporter</code> 서비스를 재구동한다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl restart nginx_prometheus_exporter</span></span><br></pre></td></tr></table></figure>


<p>그 후 <code>curl</code>로 메트릭이 수집되는지 확인해보자.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl localhost:9113/metrics</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> HELP nginx_connections_accepted Accepted client connections</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE nginx_connections_accepted counter</span></span><br><span class="line">nginx_connections_accepted 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> HELP nginx_connections_active Active client connections</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE nginx_connections_active gauge</span></span><br><span class="line">nginx_connections_active 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> HELP nginx_connections_handled Handled client connections</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE nginx_connections_handled counter</span></span><br><span class="line">nginx_connections_handled 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> HELP nginx_connections_reading Connections <span class="built_in">where</span> NGINX is reading the request header</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE nginx_connections_reading gauge</span></span><br><span class="line">nginx_connections_reading 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> HELP nginx_connections_waiting Idle client connections</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE nginx_connections_waiting gauge</span></span><br><span class="line">nginx_connections_waiting 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>


<p>이제 <code>Prometheus</code> 설정 파일을 다음과 같이 수정한다.<br>서버에서라면 <code>/etc/prometheus/prometheus.yml</code>에 있다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> my global config</span></span><br><span class="line">global:</span><br><span class="line">scrape_interval:     15s # By default, scrape targets every 15 seconds.</span><br><span class="line">evaluation_interval: 15s # By default, scrape targets every 15 seconds.</span><br><span class="line"></span><br><span class="line">external_labels:</span><br><span class="line">monitor: &#x27;my-project&#x27;</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line"><span class="meta">#</span><span class="bash"> ...</span></span><br><span class="line"></span><br><span class="line">- job_name: &#x27;nginx-prometheus-exporter&#x27;</span><br><span class="line">  scrape_interval: 5s</span><br><span class="line"></span><br><span class="line">  static_configs:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> nginx와 nginx-prometheus-exporter가 설치된 IP:9113</span></span><br><span class="line">    - targets: [&#x27;nginx-prometheus-exporter:9113&#x27;]</span><br></pre></td></tr></table></figure>

<p>그리고 <code>Prometheus</code>를 재구동한다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl restart prometheus</span></span><br></pre></td></tr></table></figure>

<p>그 후 <code>Prometheus UI</code>에서 다음을 쿼리해보자.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx_up</span><br></pre></td></tr></table></figure>

<p>다음과 같이 나오면 성공이다.</p>
<p><img src="https://user-images.githubusercontent.com/55419159/146771916-cd54be72-5e84-4f35-b5ec-233c47e827c2.png" alt="image"></p>
<hr>
<h2 id="📯-Grafana-대시보드-구축"><a href="#📯-Grafana-대시보드-구축" class="headerlink" title="📯 Grafana 대시보드 구축"></a>📯 Grafana 대시보드 구축</h2><p>이제 대시보드를 구축한다. 다음 JSON 파일을 복사해서 대시보드를 임포트한다. (로컬 환경에는 이미 대시보드가 로드되어 있다.)<br><a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/9614">다음 링크</a>로 가서 JSON 파일을 복사한다.</p>
<p><img src="https://user-images.githubusercontent.com/55419159/146773163-8fd10949-e114-4128-8cb4-79d4eb8689df.png" alt="image"></p>
<p>다음과 같은 지표를 확인할 수 있다.</p>
<ul>
<li><code>Nginx</code> 구동 상태</li>
<li><code>Nginx Connection</code> 상태</li>
<li><code>Nginx Connection</code> 개수</li>
<li><code>Nginx</code> 초당 요청 개수</li>
</ul>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Song Jae-won, Jay</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Prometheus/"># Prometheus</a>
                    
                        <a href="/tags/Nginx/"># Nginx</a>
                    
                        <a href="/tags/Nginx-prometheus-exporter/"># Nginx-prometheus-exporter</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2021/12/17/Monitoring/Fluentd/Fluentd-Prometheus/">Fluentd 를 Prometheus 로 모니터링 하기</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Song Jae-won, Jay | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>